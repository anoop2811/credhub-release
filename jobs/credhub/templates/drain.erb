#!/bin/bash

set -eu

<% active_key = p('credhub.encryption.keys').find { |key| key.key?('active') } %>
<% active_provider_name = active_key['provider_name'] %>
<% active_provider = p('credhub.encryption.providers').find { |provider| provider['name'] == active_provider_name } %>

<% if active_provider['type'] == 'dsm' %>
<% (active_provider['servers'] || []).each do |server| %>

HOST_PRIVATE_KEY_FILE=/var/vcap/jobs/credhub/config/<%= server['host'] %>.pem

cat > $HOST_PRIVATE_KEY_FILE <<EOL
<%= server['ssh_private_key'] %>
EOL

chmod 400 $HOST_PRIVATE_KEY_FILE

AGENTS=`ssh -i $HOST_PRIVATE_KEY_FILE -o StrictHostKeyChecking=no <%= server['user'] %>@<%= server['host'] %> "dsmutil agent show" 2>/dev/null`

if [[ $AGENTS =~ ${HOSTNAME} ]]; then
  ssh -i $HOST_PRIVATE_KEY_FILE -o StrictHostKeyChecking=no <%= server['user'] %>@<%= server['host'] %> "dsmutil agent delete -u ${HOSTNAME} -p <%= server['partition'] %>" &>/dev/null
fi

rm $HOST_PRIVATE_KEY_FILE

<% end %>
<% end %>

# Drain scripts must print a number to stdout:
# https://bosh.io/docs/drain.html
echo 0
