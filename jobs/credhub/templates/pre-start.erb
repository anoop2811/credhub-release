#!/bin/bash

set -eu

CERT_FILE=/var/vcap/jobs/credhub/config/cert.crt
PRIV_KEY_FILE=/var/vcap/jobs/credhub/config/priv.key
DATABASE_CA_CERT=/var/vcap/jobs/credhub/config/database_ca.crt
KEYSTORE_PASSWORD=$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c32)
CREDHUB_MTLS_TRUST_STORE_PATH=/var/vcap/jobs/credhub/config/mtls_trust_store.jks
export JAVA_HOME=/var/vcap/packages/openjdk_1.8.0/jdk

chown -R vcap /var/vcap/jobs/credhub/config
chmod 700 /var/vcap/jobs/credhub/config

<% active_key = p('credhub.encryption.keys').find { |key| key.key?('active') } %>
<% active_provider_name = active_key['provider_name'] %>
<% active_provider = p('credhub.encryption.providers').find { |provider| provider['name'] == active_provider_name } %>

<%
  begin
    p('credhub.tls.certificate')
    p('credhub.tls.private_key')
  rescue UnknownProperty
    raise "credhub.tls.certificate and credhub.tls.private_key must both be set."
  end
%>

function init_keystore_and_certs() {
  sed -i "s/KEY_STORE_PASSWORD_PLACEHOLDER/${KEYSTORE_PASSWORD}/g" /var/vcap/jobs/credhub/config/application.yml

  rm -f $CERT_FILE $PRIV_KEY_FILE $DATABASE_CA_CERT

  cat > $CERT_FILE <<EOL
<%= p('credhub.tls.certificate') %>
EOL

  cat > $PRIV_KEY_FILE <<EOL
<%= p('credhub.tls.private_key') %>
EOL

  <% if_p('credhub.data_storage.tls_ca') do |tls_ca| %>

  cat > $DATABASE_CA_CERT <<EOL
<%= tls_ca %>
EOL

  <% end %>

  <% if_p('credhub.authentication.mutual_tls.trusted_cas') do |ca_certs| %>
    <% ca_certs.each do |ca_cert| %>
      cat > /tmp/mutual_tls_ca_cert.crt <<EOL
<%= ca_cert %>
EOL
      $JAVA_HOME/bin/keytool -import -noprompt -keystore $CREDHUB_MTLS_TRUST_STORE_PATH -storepass $KEYSTORE_PASSWORD -file /tmp/mutual_tls_ca_cert.crt
      rm /tmp/mutual_tls_ca_cert.crt
    <% end %>
  <% end %>

  /var/vcap/jobs/credhub/bin/install_crt.sh $CERT_FILE $PRIV_KEY_FILE $DATABASE_CA_CERT $KEYSTORE_PASSWORD
}

if [ `grep KEY_STORE_PASSWORD_PLACEHOLDER /var/vcap/jobs/credhub/config/application.yml | wc -l` -eq 0 ]; then
  echo "Keystore appears to be initialized. Skipping keystore and cert initialization."
else
  echo "Keystore appears to be uninitialized. Setting up keystore and installing certs."
  init_keystore_and_certs
fi

<% if active_provider['type'] == 'hsm' %>
/var/vcap/jobs/credhub/bin/configure_hsm.sh
<% elsif active_provider['type'] == 'dsm' %>
/var/vcap/jobs/credhub/bin/configure_dsm.sh
<% end %>

echo 'pre-start finished!'
