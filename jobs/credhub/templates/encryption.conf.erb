<% active_key = p('credhub.encryption.keys').find { |key| key.key?('active') } %>
<% active_provider_name = active_key['provider_name'] %>
<% active_provider = p('credhub.encryption.providers').find { |provider| provider['name'] == active_provider_name } %>

<% if active_provider['type'] == 'hsm' %>
Chrystoki2 = {
  LibUNIX = /var/vcap/packages/lunaclient/lib/libCryptoki2.so;
  LibUNIX64 = /var/vcap/packages/lunaclient/lib/libCryptoki2_64.so;
}

Luna = {
  DefaultTimeOut = 500000;
  PEDTimeout1 = 100000;
  PEDTimeout2 = 200000;
  PEDTimeout3 = 10000;
  KeypairGenTimeOut = 2700000;
  CloningCommandTimeOut = 300000;
  CommandTimeOutPedSet = 720000;
}

CardReader = {
  RemoteCommand = 1;
}

Misc = {
  PE1746Enabled = 0;
  ToolsDir = /var/vcap/packages/lunaclient/bin;
}

LunaSA Client = {
  ReceiveTimeout = 20000;
  SSLConfigFile = /var/vcap/packages/lunaclient/bin/openssl.cnf;
  ClientPrivKeyFile = /var/vcap/jobs/credhub/config/client_key.pem;
  ClientCertFile = /var/vcap/jobs/credhub/config/client_cert.pem;
  ServerCAFile = /var/vcap/jobs/credhub/config/hsm_cert.pem;
  NetClient = 1;
  HtlDir = /var/vcap/packages/lunaclient/htl/;
<% active_provider['servers'].each_with_index do |hsm_server, i| %>
  ServerName0<%= i %> = <%= hsm_server['host'] %>;
  ServerPort0<%= i %> = <%= hsm_server['port'] || 1792 %>;
  ServerHtl0<%= i %> = 0;
<% end %>
}

<% elsif active_provider['type'] == 'dsm' %>
<% servers = active_provider['servers'] || [] %>
servers=<%= servers.collect { |server| server['host'] }.join(',') %>
<% end %>
