<% active_key = p('credhub.encryption.keys').find { |key| key.key?('active') } %>
<% active_provider_name = active_key['provider_name'] %>
<% active_provider = p('credhub.encryption.providers').find { |provider| provider['name'] == active_provider_name } %>

<% if active_provider['type'] == 'hsm' %>
Chrystoki2 = {
  LibUNIX = /var/vcap/packages/lunaclient/lib/libCryptoki2.so;
  LibUNIX64 = /var/vcap/packages/lunaclient/lib/libCryptoki2_64.so;
}

Luna = {
  DefaultTimeOut = 500000;
  PEDTimeout1 = 100000;
  PEDTimeout2 = 200000;
  PEDTimeout3 = 10000;
  KeypairGenTimeOut = 2700000;
  CloningCommandTimeOut = 300000;
  CommandTimeOutPedSet = 720000;
}

CardReader = {
  RemoteCommand = 1;
}

Misc = {
  PE1746Enabled = 0;
  ToolsDir = /var/vcap/packages/lunaclient/bin;
}

LunaSA Client = {
  ReceiveTimeout = 20000;
  SSLConfigFile = /var/vcap/packages/lunaclient/bin/openssl.cnf;
  ClientPrivKeyFile = /var/vcap/jobs/credhub/config/client_key.pem;
  ClientCertFile = /var/vcap/jobs/credhub/config/client_cert.pem;
  ServerCAFile = /var/vcap/jobs/credhub/config/hsm_cert.pem;
  NetClient = 1;
  HtlDir = /var/vcap/packages/lunaclient/htl/;
<% hsm_host = active_provider['host'] %>
<% hsm_port = active_provider['port'] || 1792 %>
<% if hsm_host %>
  ServerName00 = <%= hsm_host %>;
<% end %>
  ServerPort00 = <%= hsm_port %>;
  ServerHtl00 = 0;
}

<% elsif active_provider['type'] == 'dsm' %>
<% servers = active_provider['servers'] || [] %>
servers=<%= servers.collect { |server| server['host'] }.join(',') %>
<% end %>
